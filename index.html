<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>NowGG Cloud â€” Sigma</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#00ffcc;--accent-dark:#00ff66;--bg1:#0f172a;--bg2:#6b21a8;--bg3:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      background-size:300% 300%;animation:grad 12s ease infinite;color:#fff;
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .card{width:360px;background:rgba(0,0,0,0.55);padding:26px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.6);text-align:center}
    h1{margin:0 0 8px;font-size:20px;color:var(--accent);text-shadow:0 0 8px var(--accent)}
    p.lead{margin:6px 0 18px;color:#ddd;font-size:14px}
    input[type="text"]{width:100%;padding:12px;border-radius:10px;border:none;background:#0b0b0b;color:#fff;outline:none;text-align:center;box-shadow:inset 0 0 10px rgba(0,0,0,0.6);margin-bottom:12px}
    .btn{display:inline-block;padding:11px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;margin:6px 6px;transition:transform .14s,box-shadow .14s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#000}
    .btn-amber{background:linear-gradient(90deg,#ffcc00,#ff6600);color:#111}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}
    .msg{margin-top:12px;font-size:0.95rem;min-height:28px}
    .desktop{display:none;flex-direction:column;align-items:center;gap:12px;width:100%;padding-top:6px}
    #keyTimer{font-size:0.95rem;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.04)}
    #adminBadge{margin-top:8px;font-size:0.95rem;color:#ffd166;text-shadow:0 0 8px #ffd166;display:none}
    .icons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .icon{width:88px;text-align:center;cursor:pointer}
    .icon img{width:64px;height:64px;border-radius:10px;background:#fff;padding:6px}
    #topbar{position:fixed;top:0;left:0;width:100%;height:52px;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:flex-end;padding-right:12px;z-index:40}
    #topbar button{background:#ff4d4d;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    iframe{position:fixed;top:52px;left:0;width:100%;height:calc(100% - 52px);border:none;display:none;z-index:35}
    .small{font-size:13px;color:#cfcfcf}
    @media (max-width:420px){.card{width:94%}.icon img{width:56px;height:56px}}
  </style>
</head>
<body>
  <div class="card" id="loginCard">
    <h1>ğŸ” NowGG Cloud â€” Sigma</h1>
    <p class="lead">Nháº¥n "VÆ°á»£t link" Ä‘á»ƒ Ä‘Æ°á»£c cáº¥p quyá»n truy cáº­p. Sau khi hoÃ n thÃ nh bÃªn Link4m, báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn vá» Ä‘Ã¢y.</p>

    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-amber" onclick="goLink()">ğŸš€ VÆ°á»£t link</button>
      <button class="btn btn-primary" onclick="manualCodePrompt()">ğŸ” CÃ³ mÃ£? DÃ¡n mÃ£</button>
      <button class="btn btn-ghost" onclick="openGuide()">ğŸ“– HDSD</button>
    </div>

    <div class="msg" id="statusMsg"></div>
    <div style="margin-top:10px" class="small">LÆ°u Ã½: Link3rd-party sáº½ xá»­ lÃ½ quÃ¡ trÃ¬nh vÃ  pháº£i redirect láº¡i vá»›i <code>?code=XYZ</code> Ä‘á»ƒ xÃ¡c thá»±c.</div>
  </div>

  <div class="card desktop" id="desktop">
    <h1 style="font-size:18px;color:var(--accent)">NowGG Cloud â€” Dashboard</h1>
    <div id="keyTimer">â³ Tráº¡ng thÃ¡i: chÆ°a xÃ¡c thá»±c</div>
    <div id="adminBadge">ğŸ”’ Admin Mode</div>
    <div class="icons" style="margin-top:12px">
      <div class="icon" onclick="openApp()">
        <img src="https://cms-cdn.now.gg/cms-media/2022/12/nowgg-full-logo.png" alt="App">
        <div class="small">Má»Ÿ App</div>
      </div>
      <div class="icon" onclick="openGuide()">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png" alt="guide">
        <div class="small">HDSD</div>
      </div>
      <div class="icon" onclick="openUpdate()">
        <img src="https://png.pngtree.com/png-clipart/20230508/original/pngtree-sticky-note-flat-icon-png-image_9150666.png" alt="update">
        <div class="small">Update</div>
      </div>
      <div class="icon" onclick="logout()">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" alt="logout">
        <div class="small">ÄÄƒng xuáº¥t</div>
      </div>
    </div>
  </div>

  <div id="topbar"><button onclick="closeApp()">ÄÃ³ng</button></div>
  <iframe id="appFrame" src=""></iframe>

  <!-- Update Modal -->
  <div id="updateModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.75);z-index:60;align-items:center;justify-content:center;">
    <div style="background:#111;padding:18px;border-radius:12px;max-width:420px;width:92%;color:#fff;box-shadow:0 6px 24px rgba(0,0,0,0.6);">
      <h3 style="margin:0 0 8px;color:#00ffcc;text-align:center">ğŸ“¢ Cáº­p nháº­t má»›i</h3>
      <ul style="text-align:left;line-height:1.6;color:#ddd">
        <li>âš¡ Tá»‘i Æ°u hiá»‡u nÄƒng app.</li>
        <li>ğŸ”’ Bá»• sung kiá»ƒm tra server-side.</li>
        <li>ğŸ› ï¸ Fix má»™t sá»‘ lá»—i UI nhá».</li>
      </ul>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button onclick="closeUpdate()" style="flex:1;padding:10px;border-radius:8px;border:none;background:#00ffcc;color:#000;font-weight:700;cursor:pointer">ÄÃ³ng</button>
      </div>
    </div>
  </div>

<script>
/*
  Frontend index.html cho GitHub Pages (repo: sigma-nowgg.github.io)
  Server URL: https://nowgg-server.onrender.com
*/

const SERVER_URL = "https://nowgg-server.onrender.com";
const LINK4M = "https://link4m.com/Xi9JlT";
const VISITED_FLAG = "sigma_nowgg_visitedLink";
const VISITED_TIME = "sigma_nowgg_visitedLinkTime";
const STATUS = document.getElementById("statusMsg");

function setStatus(txt, cls){
  STATUS.textContent = txt;
  if(cls) STATUS.className = cls;
}

// Redirect user to link4m and set flag
function goLink(){
  try {
    localStorage.setItem(VISITED_FLAG, "true");
    localStorage.setItem(VISITED_TIME, Date.now().toString());
    // Redirect to link4m; expecting link4m to redirect back to this page with ?code=XYZ
    window.location.href = LINK4M;
  } catch(e){
    setStatus("âŒ KhÃ´ng thá»ƒ lÆ°u flag localStorage. HÃ£y copy link thá»§ cÃ´ng: " + LINK4M);
  }
}

// If user has a code (e.g. pasted), allow manual input
function manualCodePrompt(){
  const code = prompt("DÃ¡n mÃ£ (code) báº¡n nháº­n Ä‘Æ°á»£c tá»« link4m vÃ o Ä‘Ã¢y:");
  if(!code) return;
  setStatus("â³ Äang gá»­i mÃ£ tá»›i server...");
  issueCodeToServer(code);
}

// Open guide (copy link)
function openGuide(){
  const yt = "https://www.youtube.com/watch?v=ZL2YvVOToBw";
  navigator.clipboard.writeText(yt).then(()=>{ alert("ğŸ“‹ Link hÆ°á»›ng dáº«n Ä‘Ã£ Ä‘Æ°á»£c copy!"); }).catch(()=>{ alert("âŒ KhÃ´ng copy Ä‘Æ°á»£c, hÃ£y copy thá»§ cÃ´ng: " + yt); });
}

// Open update modal
function openUpdate(){ document.getElementById("updateModal").style.display = "flex"; }
function closeUpdate(){ document.getElementById("updateModal").style.display = "none"; }

// Send code to server /issue to set HttpOnly cookie
async function issueCodeToServer(code){
  try {
    const resp = await fetch(SERVER_URL + "/issue", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ code }),
      credentials: "include" // important: to receive HttpOnly cookie set by server
    });
    if(!resp.ok){
      const t = await resp.text().catch(()=>null);
      setStatus("âŒ Server tráº£ lá»—i: " + (t || resp.status));
      return;
    }
    const data = await resp.json().catch(()=> ({}));
    if(data && data.ok){
      setStatus("âœ… XÃ¡c thá»±c thÃ nh cÃ´ng â€” má»Ÿ dashboard...");
      // má»Ÿ dashboard tá»« server (cookie sáº½ kÃ¨m theo)
      setTimeout(()=>{ openApp(true); }, 700);
    } else {
      setStatus("âŒ XÃ¡c thá»±c tháº¥t báº¡i.");
    }
  } catch(e){
    console.error(e);
    setStatus("âŒ Lá»—i káº¿t ná»‘i tá»›i server.");
  }
}

// On load: detect code param and visited flag
async function handleReturnFromLink(){
  // Snowflake visual isn't required here; minimal.
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const visited = localStorage.getItem(VISITED_FLAG);
  const visitedTime = parseInt(localStorage.getItem(VISITED_TIME) || "0", 10);
  const MAX_RETURN_MS = 24 * 3600 * 1000; // chá»‰ cháº¥p nháº­n flag trong 24h (tÃ¹y chá»‰nh)

  // If code present AND flag exists (to ensure user clicked VÆ°á»£t link earlier)
  if(code && visited === "true"){
    // optional: check time window
    if(Date.now() - visitedTime > MAX_RETURN_MS){
      setStatus("âš ï¸ Thá»i gian quay láº¡i quÃ¡ lÃ¢u. HÃ£y báº¥m 'VÆ°á»£t link' láº¡i.");
      localStorage.removeItem(VISITED_FLAG);
      localStorage.removeItem(VISITED_TIME);
      return;
    }
    setStatus("â³ Äang xÃ¡c thá»±c code tá»« link4m...");
    // send to server
    await issueCodeToServer(code);
    // remove params from URL (clean)
    try {
      const url = new URL(window.location.href);
      url.search = "";
      window.history.replaceState({}, document.title, url.toString());
    } catch(e){}
    localStorage.removeItem(VISITED_FLAG);
    localStorage.removeItem(VISITED_TIME);
    return;
  }

  // If no code but visited flag present (user clicked VÆ°á»£t link but returned without code)
  if(!code && visited === "true"){
    setStatus("âš ï¸ Báº¡n Ä‘Ã£ báº¥m 'VÆ°á»£t link' nhÆ°ng khÃ´ng cÃ³ mÃ£ tráº£ vá». HÃ£y kiá»ƒm tra quÃ¡ trÃ¬nh trÃªn link4m hoáº·c báº¥m 'VÆ°á»£t link' láº¡i.");
    // keep flag for a short time in case user retries
    setTimeout(()=>{}, 0);
    return;
  }

  // Otherwise normal entry
  setStatus("");
}

// Open the dashboard/app in iframe. If fromServer === true then open server /app; else open your own iframe (fallback)
function openApp(fromServer=false){
  const f = document.getElementById("appFrame");
  if(fromServer){
    f.src = SERVER_URL + "/app";
  } else {
    // fallback (if you want open a proxy link)
    f.src = "https://uproxy.online/ultraviolet/hvtrs8%2F-nmw%2Cge%2Fcprs-cnuqtgr%2Filc-9355%2Falwsvep.jtol";
  }
  f.style.display = "block";
  document.getElementById("topbar").style.display = "flex";
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("desktop").style.display = "flex";
  document.getElementById("keyTimer").textContent = "â³ Äang truy cáº­p dashboard";
  document.getElementById("adminBadge").style.display = "none";
}

// Close app iframe
function closeApp(){
  document.getElementById("appFrame").src = "";
  document.getElementById("appFrame").style.display = "none";
  document.getElementById("topbar").style.display = "none";
  // show desktop or login again based on state
  document.getElementById("desktop").style.display = "flex";
}

// Logout: call server /logout to clear cookie and revert to login UI
async function logout(){
  try {
    const resp = await fetch(SERVER_URL + "/logout", {
      method: "POST",
      credentials: "include"
    });
    // ignore response, just reset UI
  } catch(e){
    console.warn("logout error", e);
  }
  closeApp();
  document.getElementById("desktop").style.display = "none";
  document.getElementById("loginCard").style.display = "block";
  setStatus("âœ… ÄÃ£ Ä‘Äƒng xuáº¥t.");
}

// On initial load
window.addEventListener("DOMContentLoaded", async () => {
  await handleReturnFromLink();
});
</script>
</body>
</html>
