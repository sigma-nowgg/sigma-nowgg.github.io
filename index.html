<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>NowGG Cloud</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0;font-family:sans-serif;background:#0f172a;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh; }
    .card { background:rgba(0,0,0,0.6);padding:24px;border-radius:14px;max-width:420px;width:92%;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.6); }
    h1 { margin-top:0;font-size:22px;color:#00ffcc;text-shadow:0 0 6px #00ffcc; }
    button { margin:8px;padding:12px 20px;border:none;border-radius:8px;font-weight:bold;cursor:pointer; }
    .btn-link { background:linear-gradient(90deg,#00ffcc,#00ff66);color:#000; }
    .btn-ghost { background:transparent;border:1px solid #aaa;color:#fff; }
    #status { margin-top:10px;min-height:20px;color:#ffcc00;font-size:14px; }
    #dashboard { display:none; }
    iframe { width:100%;height:420px;border:none;margin-top:12px;display:none; }
    #topbar{position:fixed;top:0;left:0;width:100%;height:44px;background:#000;display:none;align-items:center;justify-content:flex-end;padding-right:12px;z-index:50}
    #topbar button{background:#ff4d4d;border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <!-- Login -->
  <div class="card" id="loginCard">
    <h1>🔐 NowGG Cloud</h1>
    <p>Bấm nút để vượt link và nhận quyền truy cập (2 ngày).</p>
    <button class="btn-link" onclick="goLink()">🚀 Vượt link</button>
    <button class="btn-ghost" onclick="checkLogin()">🔎 Kiểm tra trạng thái</button>
    <div id="status"></div>
  </div>

  <!-- Dashboard -->
  <div class="card" id="dashboard">
    <h1>📂 Dashboard</h1>
    <button class="btn-link" onclick="openApp()">Mở App</button>
    <button class="btn-ghost" onclick="openUpdate()">📢 Cập nhật</button>
    <button class="btn-ghost" onclick="logout()">Đăng xuất</button>
    <iframe id="appFrame"></iframe>
  </div>

  <!-- Topbar for iframe -->
  <div id="topbar"><button onclick="closeApp()">Đóng</button></div>

  <!-- Modal Update -->
  <div id="updateModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center;">
    <div style="background:#222;padding:20px;border-radius:14px;max-width:360px;width:90%;color:#fff;box-shadow:0 6px 24px rgba(0,0,0,0.6);">
      <h2 style="margin-top:0;color:#00ffcc;text-align:center;">📢 Cập nhật mới</h2>
      <ul style="text-align:left;line-height:1.6;">
        <li>⚡ Tối ưu hiệu năng khi chạy app.</li>
        <li>🔒 Cải thiện bảo mật key.</li>
      </ul>
      <button onclick="closeUpdate()" style="margin-top:12px;width:100%;padding:10px;border:none;border-radius:10px;background:#00ffcc;color:#000;font-weight:bold;cursor:pointer;">
        Đóng
      </button>
    </div>
  </div>

<script>
const LINK4M = "https://link4m.com/qIzP1";
const SERVER_URL = "https://nowgg-server.onrender.com";

// Redirect sang link4m
function goLink(){
  localStorage.setItem("visitedLink","true");
  window.location.href = LINK4M;
}

// Gửi code về server để lấy cookie
async function verifyCode(code){
  document.getElementById("status").textContent = "⏳ Đang xác thực...";
  try {
    const res = await fetch(SERVER_URL + "/issue", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ code }),
      credentials:"include"
    });
    const data = await res.json();
    if(data.ok){ showDashboard(); }
    else { document.getElementById("status").textContent="❌ Xác thực thất bại"; }
  } catch(e){
    document.getElementById("status").textContent="❌ Lỗi kết nối server";
  }
}

// Kiểm tra trạng thái cookie
async function checkLogin(){
  document.getElementById("status").textContent="⏳ Đang kiểm tra...";
  try {
    const res = await fetch(SERVER_URL + "/app",{ credentials:"include" });
    if(res.ok){ showDashboard(); }
    else { document.getElementById("status").textContent="⚠️ Phiên hết hạn, hãy vượt link lại"; }
  } catch(e){
    document.getElementById("status").textContent="❌ Không kết nối được server";
  }
}

// Hiện dashboard
function showDashboard(){
  document.getElementById("loginCard").style.display="none";
  document.getElementById("dashboard").style.display="block";
}

// Mở App
function openApp(){
  const f=document.getElementById("appFrame");
  f.style.display="block";
  f.src="https://uproxy.online/ultraviolet/";
  document.getElementById("topbar").style.display="flex";
}
function closeApp(){
  const f=document.getElementById("appFrame");
  f.src=""; f.style.display="none";
  document.getElementById("topbar").style.display="none";
}

// Logout
async function logout(){
  try{ await fetch(SERVER_URL+"/logout",{method:"POST",credentials:"include"});}catch(e){}
  document.getElementById("dashboard").style.display="none";
  document.getElementById("loginCard").style.display="block";
  document.getElementById("status").textContent="✅ Đã đăng xuất.";
  document.getElementById("appFrame").style.display="none";
  document.getElementById("appFrame").src="";
}

// Update modal
function openUpdate(){ document.getElementById("updateModal").style.display="flex"; }
function closeUpdate(){ document.getElementById("updateModal").style.display="none"; }

// Khi load trang
window.addEventListener("DOMContentLoaded",()=>{
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  const visited=localStorage.getItem("visitedLink");

  if(code && visited==="true"){
    localStorage.removeItem("visitedLink");
    verifyCode(code);
    const cleanUrl=window.location.origin+window.location.pathname;
    window.history.replaceState({},document.title,cleanUrl);
  } else {
    checkLogin(); // auto check trạng thái khi load
  }
});
</script>
</body>
</html>
