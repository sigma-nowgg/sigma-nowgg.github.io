<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>NowGG Cloud ‚Äî Sigma</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#00ffcc;--accent-dark:#00ff66;--bg1:#0f172a;--bg2:#6b21a8;--bg3:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Roboto',sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      background-size:300% 300%;animation:grad 12s ease infinite;color:#fff;
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
    }
    @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .card{width:360px;background:rgba(0,0,0,0.55);padding:26px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.6);text-align:center}
    h1{margin:0 0 8px;font-size:20px;color:var(--accent);text-shadow:0 0 8px var(--accent)}
    p.lead{margin:6px 0 18px;color:#ddd;font-size:14px}
    input[type="text"]{width:100%;padding:12px;border-radius:10px;border:none;background:#0b0b0b;color:#fff;outline:none;text-align:center;box-shadow:inset 0 0 10px rgba(0,0,0,0.6);margin-bottom:12px}
    .btn{display:inline-block;padding:11px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;margin:6px 6px;transition:transform .14s,box-shadow .14s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#000}
    .btn-amber{background:linear-gradient(90deg,#ffcc00,#ff6600);color:#111}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}
    .msg{margin-top:12px;font-size:0.95rem;min-height:28px}
    .desktop{display:none;flex-direction:column;align-items:center;gap:12px;width:100%;padding-top:6px}
    #keyTimer{font-size:0.95rem;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.04)}
    #adminBadge{margin-top:8px;font-size:0.95rem;color:#ffd166;text-shadow:0 0 8px #ffd166;display:none}
    .icons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .icon{width:88px;text-align:center;cursor:pointer}
    .icon img{width:64px;height:64px;border-radius:10px;background:#fff;padding:6px}
    #topbar{position:fixed;top:0;left:0;width:100%;height:52px;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:flex-end;padding-right:12px;z-index:40}
    #topbar button{background:#ff4d4d;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    iframe{position:fixed;top:52px;left:0;width:100%;height:calc(100% - 52px);border:none;display:none;z-index:35}
    .small{font-size:13px;color:#cfcfcf}
    @media (max-width:420px){.card{width:94%}.icon img{width:56px;height:56px}}
  </style>
</head>
<body>
  <div class="card" id="loginCard">
    <h1>üîê NowGG Cloud ‚Äî Sigma</h1>
    <p class="lead">Nh·∫•n "V∆∞·ª£t link" ƒë·ªÉ ƒë∆∞·ª£c c·∫•p quy·ªÅn truy c·∫≠p. Sau khi ho√†n th√†nh b√™n Link4m, b·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ ƒë√¢y.</p>

    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-amber" onclick="goLink()">üöÄ V∆∞·ª£t link</button>
      <button class="btn btn-primary" onclick="manualCodePrompt()">üîÅ C√≥ m√£? D√°n m√£</button>
      <button class="btn btn-ghost" onclick="openGuide()">üìñ HDSD</button>
    </div>

    <div class="msg" id="statusMsg"></div>
    <div style="margin-top:10px" class="small">L∆∞u √Ω: Link3rd-party s·∫Ω x·ª≠ l√Ω qu√° tr√¨nh v√† ph·∫£i redirect l·∫°i v·ªõi <code>?code=XYZ</code> ƒë·ªÉ x√°c th·ª±c.</div>
  </div>

  <div class="card desktop" id="desktop">
    <h1 style="font-size:18px;color:var(--accent)">NowGG Cloud ‚Äî Dashboard</h1>
    <div id="keyTimer">‚è≥ Tr·∫°ng th√°i: ch∆∞a x√°c th·ª±c</div>
    <div id="adminBadge">üîí Admin Mode</div>
    <div class="icons" style="margin-top:12px">
      <div class="icon" onclick="openApp()">
        <img src="https://cms-cdn.now.gg/cms-media/2022/12/nowgg-full-logo.png" alt="App">
        <div class="small">M·ªü App</div>
      </div>
      <div class="icon" onclick="openGuide()">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png" alt="guide">
        <div class="small">HDSD</div>
      </div>
      <div class="icon" onclick="openUpdate()">
        <img src="https://png.pngtree.com/png-clipart/20230508/original/pngtree-sticky-note-flat-icon-png-image_9150666.png" alt="update">
        <div class="small">Update</div>
      </div>
      <div class="icon" onclick="logout()">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" alt="logout">
        <div class="small">ƒêƒÉng xu·∫•t</div>
      </div>
    </div>
  </div>

  <div id="topbar"><button onclick="closeApp()">ƒê√≥ng</button></div>
  <iframe id="appFrame" src=""></iframe>

  <!-- Update Modal -->
  <div id="updateModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.75);z-index:60;align-items:center;justify-content:center;">
    <div style="background:#111;padding:18px;border-radius:12px;max-width:420px;width:92%;color:#fff;box-shadow:0 6px 24px rgba(0,0,0,0.6);">
      <h3 style="margin:0 0 8px;color:#00ffcc;text-align:center">üì¢ C·∫≠p nh·∫≠t m·ªõi</h3>
      <ul style="text-align:left;line-height:1.6;color:#ddd">
        <li>‚ö° T·ªëi ∆∞u hi·ªáu nƒÉng app.</li>
        <li>üîí B·ªï sung ki·ªÉm tra server-side.</li>
        <li>üõ†Ô∏è Fix m·ªôt s·ªë l·ªói UI nh·ªè.</li>
      </ul>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button onclick="closeUpdate()" style="flex:1;padding:10px;border-radius:8px;border:none;background:#00ffcc;color:#000;font-weight:700;cursor:pointer">ƒê√≥ng</button>
      </div>
    </div>
  </div>

<script>
/*
  Frontend index.html cho GitHub Pages (repo: sigma-nowgg.github.io)
  Server URL: https://nowgg-server.onrender.com
*/

const SERVER_URL = "https://nowgg-server.onrender.com";
const LINK4M = "https://link4m.com/Xi9JlT";
const VISITED_FLAG = "sigma_nowgg_visitedLink";
const VISITED_TIME = "sigma_nowgg_visitedLinkTime";
const STATUS = document.getElementById("statusMsg");

function setStatus(txt, cls){
  STATUS.textContent = txt;
  if(cls) STATUS.className = cls;
}

// Redirect user to link4m and set flag
function goLink(){
  try {
    localStorage.setItem(VISITED_FLAG, "true");
    localStorage.setItem(VISITED_TIME, Date.now().toString());
    // Redirect to link4m; expecting link4m to redirect back to this page with ?code=XYZ
    window.location.href = LINK4M;
  } catch(e){
    setStatus("‚ùå Kh√¥ng th·ªÉ l∆∞u flag localStorage. H√£y copy link th·ªß c√¥ng: " + LINK4M);
  }
}

// If user has a code (e.g. pasted), allow manual input
function manualCodePrompt(){
  const code = prompt("D√°n m√£ (code) b·∫°n nh·∫≠n ƒë∆∞·ª£c t·ª´ link4m v√†o ƒë√¢y:");
  if(!code) return;
  setStatus("‚è≥ ƒêang g·ª≠i m√£ t·ªõi server...");
  issueCodeToServer(code);
}

// Open guide (copy link)
function openGuide(){
  const yt = "https://www.youtube.com/watch?v=ZL2YvVOToBw";
  navigator.clipboard.writeText(yt).then(()=>{ alert("üìã Link h∆∞·ªõng d·∫´n ƒë√£ ƒë∆∞·ª£c copy!"); }).catch(()=>{ alert("‚ùå Kh√¥ng copy ƒë∆∞·ª£c, h√£y copy th·ªß c√¥ng: " + yt); });
}

// Open update modal
function openUpdate(){ document.getElementById("updateModal").style.display = "flex"; }
function closeUpdate(){ document.getElementById("updateModal").style.display = "none"; }

// Send code to server /issue to set HttpOnly cookie
async function issueCodeToServer(code){
  try {
    const resp = await fetch(SERVER_URL + "/issue", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ code }),
      credentials: "include" // important: to receive HttpOnly cookie set by server
    });
    if(!resp.ok){
      const t = await resp.text().catch(()=>null);
      setStatus("‚ùå Server tr·∫£ l·ªói: " + (t || resp.status));
      return;
    }
    const data = await resp.json().catch(()=> ({}));
    if(data && data.ok){
      setStatus("‚úÖ X√°c th·ª±c th√†nh c√¥ng ‚Äî m·ªü dashboard...");
      // m·ªü dashboard t·ª´ server (cookie s·∫Ω k√®m theo)
      setTimeout(()=>{ openApp(true); }, 700);
    } else {
      setStatus("‚ùå X√°c th·ª±c th·∫•t b·∫°i.");
    }
  } catch(e){
    console.error(e);
    setStatus("‚ùå L·ªói k·∫øt n·ªëi t·ªõi server.");
  }
}

// On load: detect code param and visited flag
async function handleReturnFromLink(){
  // Snowflake visual isn't required here; minimal.
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const visited = localStorage.getItem(VISITED_FLAG);
  const visitedTime = parseInt(localStorage.getItem(VISITED_TIME) || "0", 10);
  const MAX_RETURN_MS = 24 * 3600 * 1000; // ch·ªâ ch·∫•p nh·∫≠n flag trong 24h (t√πy ch·ªânh)

  // If code present AND flag exists (to ensure user clicked V∆∞·ª£t link earlier)
  if(code && visited === "true"){
    // optional: check time window
    if(Date.now() - visitedTime > MAX_RETURN_MS){
      setStatus("‚ö†Ô∏è Th·ªùi gian quay l·∫°i qu√° l√¢u. H√£y b·∫•m 'V∆∞·ª£t link' l·∫°i.");
      localStorage.removeItem(VISITED_FLAG);
      localStorage.removeItem(VISITED_TIME);
      return;
    }
    setStatus("‚è≥ ƒêang x√°c th·ª±c code t·ª´ link4m...");
    // send to server
    await issueCodeToServer(code);
    // remove params from URL (clean)
    try {
      const url = new URL(window.location.href);
      url.search = "";
      window.history.replaceState({}, document.title, url.toString());
    } catch(e){}
    localStorage.removeItem(VISITED_FLAG);
    localStorage.removeItem(VISITED_TIME);
    return;
  }

  // If no code but visited flag present (user clicked V∆∞·ª£t link but returned without code)
  if(!code && visited === "true"){
    setStatus("‚ö†Ô∏è B·∫°n ƒë√£ b·∫•m 'V∆∞·ª£t link' nh∆∞ng kh√¥ng c√≥ m√£ tr·∫£ v·ªÅ. H√£y ki·ªÉm tra qu√° tr√¨nh tr√™n link4m ho·∫∑c b·∫•m 'V∆∞·ª£t link' l·∫°i.");
    // keep flag for a short time in case user retries
    setTimeout(()=>{}, 0);
    return;
  }

  // Otherwise normal entry
  setStatus("");
}

// Open the dashboard/app in iframe. If fromServer === true then open server /app; else open your own iframe (fallback)
function openApp(fromServer=false){
  const f = document.getElementById("appFrame");
  if(fromServer){
    f.src = SERVER_URL + "/app";
  } else {
    // fallback (if you want open a proxy link)
    f.src = "https://uproxy.online/ultraviolet/hvtrs8%2F-nmw%2Cge%2Fcprs-cnuqtgr%2Filc-9355%2Falwsvep.jtol";
  }
  f.style.display = "block";
  document.getElementById("topbar").style.display = "flex";
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("desktop").style.display = "flex";
  document.getElementById("keyTimer").textContent = "‚è≥ ƒêang truy c·∫≠p dashboard";
  document.getElementById("adminBadge").style.display = "none";
}

// Close app iframe
function closeApp(){
  document.getElementById("appFrame").src = "";
  document.getElementById("appFrame").style.display = "none";
  document.getElementById("topbar").style.display = "none";
  // show desktop or login again based on state
  document.getElementById("desktop").style.display = "flex";
}

// Logout: call server /logout to clear cookie and revert to login UI
async function logout(){
  try {
    const resp = await fetch(SERVER_URL + "/logout", {
      method: "POST",
      credentials: "include"
    });
    // ignore response, just reset UI
  } catch(e){
    console.warn("logout error", e);
  }
  closeApp();
  document.getElementById("desktop").style.display = "none";
  document.getElementById("loginCard").style.display = "block";
  setStatus("‚úÖ ƒê√£ ƒëƒÉng xu·∫•t.");
}

// On initial load
window.addEventListener("DOMContentLoaded", async () => {
  await handleReturnFromLink();
});
</script>
</body>
</html>
