<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>NowGG Cloud</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"> 
  <style>
    :root{--accent:#00ffcc;--accent-dark:#00ff66;--bg1:#3b073b;--bg2:#8b2245;--bg3:#c0392b}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Roboto',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));background-size:300% 300%;animation:grad 12s ease infinite;color:#fff;height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
    @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .card{width:360px;background:rgba(0,0,0,0.6);padding:28px;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.6);text-align:center}
    h1{margin:0 0 10px;font-size:20px;color:var(--accent);text-shadow:0 0 8px var(--accent)}
    p.lead{margin:6px 0 16px;color:#ddd}
    .btn{width:100%;padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;margin-top:8px;transition:transform .18s}
    .btn:active{transform:translateY(1px)}
    .btn-get{background:linear-gradient(90deg,#ffbb00,#ff6a00);color:#111}
    .btn-check{background:linear-gradient(90deg,#00ffd1,#00d18a);color:#000}
    .small{font-size:13px;color:#cfcfcf;margin-top:10px}
    #status{min-height:22px;margin-top:12px;color:#ffeaa7}
    .desktop{display:none;flex-direction:column;align-items:center;gap:14px}
    .icons{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:8px}
    .icon{width:96px;text-align:center;cursor:pointer}
    .icon img{width:72px;height:72px;border-radius:10px;background:#fff;padding:6px}
    #topbar{position:fixed;top:0;left:0;width:100%;height:46px;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:flex-end;padding-right:14px;z-index:60}
    #topbar button{background:#ff4d4d;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    iframe{position:fixed;top:46px;left:0;width:100%;height:calc(100% - 46px);border:none;display:none;z-index:50}
    @media (max-width:420px){.card{width:92%}.icon img{width:56px;height:56px}}
  </style>
</head>
<body>
  <div class="card" id="loginCard">
    <h1>üîê NowGG Cloud</h1>
    <p class="lead">B·∫•m "L·∫•y Key" ƒë·ªÉ v∆∞·ª£t link. Sau khi ho√†n th√†nh Link4m s·∫Ω redirect v·ªÅ trang n√†y v√† b·∫°n s·∫Ω ƒë∆∞·ª£c m·ªü giao di·ªán.</p>

    <!-- REMOVED: input + confirm -->
    <button class="btn btn-get" onclick="goLink()">üöÄ L·∫•y Key</button>
    <button class="btn btn-check" onclick="checkLogin()">üîé Ki·ªÉm tra tr·∫°ng th√°i</button>

    <div id="status" class="small"></div>
    <div class="small" style="margin-top:8px">L∆∞u √Ω: Key c√≥ hi·ªáu l·ª±c 48 gi·ªù (do server c·∫•p). N·∫øu h·∫øt h·∫°n, vui l√≤ng L·∫•y Key l·∫°i.</div>
  </div>

  <div class="card desktop" id="desktop">
    <h1 style="font-size:18px;color:var(--accent)">NowGG Cloud ‚Äî Dashboard</h1>
    <div id="keyTimer" class="small">‚è≥ Tr·∫°ng th√°i: ƒêang ki·ªÉm tra...</div>

    <div class="icons">
      <div class="icon" onclick="openApp()">
        <img src="https://cms-cdn.now.gg/cms-media/2022/12/nowgg-full-logo.png" alt="app">
        <div class="small">M·ªü App</div>
      </div>
      <div class="icon" onclick="openUpdate()">
        <img src="https://png.pngtree.com/png-clipart/20230508/original/pngtree-sticky-note-flat-icon-png-image_9150666.png" alt="update">
        <div class="small">C·∫≠p nh·∫≠t</div>
      </div>
      <div class="icon" onclick="logout()">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" alt="logout">
        <div class="small">ƒêƒÉng xu·∫•t</div>
      </div>
    </div>
  </div>

  <div id="topbar"><button onclick="closeApp()">ƒê√≥ng</button></div>
  <iframe id="appFrame" src=""></iframe>

  <!-- Update modal -->
  <div id="updateModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:70;align-items:center;justify-content:center;">
    <div style="background:#111;padding:18px;border-radius:12px;max-width:420px;width:92%;color:#fff;box-shadow:0 6px 24px rgba(0,0,0,0.6);">
      <h3 style="margin:0 0 8px;color:var(--accent);text-align:center">üì¢ C·∫≠p nh·∫≠t</h3>
      <ul style="text-align:left;color:#ddd;line-height:1.6">
        <li>‚ö° T·ªëi ∆∞u hi·ªáu nƒÉng</li>
        <li>üîí Ki·ªÉm tra server-side khi c·∫•p quy·ªÅn</li>
      </ul>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:700" onclick="closeUpdate()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

<script>
/*
  Flow:
  - goLink() => set visited flag + redirect to Link4m
  - When Link4m redirects back to site with ?code=XYZ, script sends POST /issue (credentials include)
    to SERVER_URL. If server returns {ok:true} -> open dashboard.
  - checkLogin() calls GET /app to verify cookie/session.
  - No input field / no confirm button.
*/

const LINK4M = "https://link4m.com/qIzP1";
const SERVER_URL = "https://nowgg-server.onrender.com";

function setStatus(txt){
  document.getElementById("status").textContent = txt || "";
}

// Redirect user to Link4m and set visited flag
function goLink(){
  try {
    localStorage.setItem("visitedLink", "true");
    // optionally save timestamp
    localStorage.setItem("visitedTime", Date.now().toString());
  } catch(e){}
  window.location.href = LINK4M;
}

// Called when we have code returned from Link4m
async function verifyCode(code){
  setStatus("‚è≥ ƒêang x√°c th·ª±c code...");
  try {
    const res = await fetch(SERVER_URL + "/issue", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code }),
      credentials: "include" // important to receive HttpOnly cookie
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>null);
      setStatus("‚ùå Server: " + (txt || res.status));
      return false;
    }
    const data = await res.json().catch(()=>({}));
    if(data && data.ok){
      setStatus("‚úÖ X√°c th·ª±c th√†nh c√¥ng. M·ªü dashboard...");
      openDashboardAfterAuth();
      return true;
    } else {
      setStatus("‚ùå X√°c th·ª±c th·∫•t b·∫°i.");
      return false;
    }
  } catch(err){
    console.error(err);
    setStatus("‚ùå L·ªói k·∫øt n·ªëi server.");
    return false;
  }
}

// Check if session cookie is valid by calling protected /app
async function checkLogin(){
  setStatus("‚è≥ Ki·ªÉm tra tr·∫°ng th√°i...");
  try {
    const res = await fetch(SERVER_URL + "/app", { credentials: "include" });
    if(res.ok){
      setStatus("‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p. M·ªü dashboard...");
      openDashboardAfterAuth();
    } else {
      setStatus("‚ö†Ô∏è Ch∆∞a c√≥ phi√™n h·ª£p l·ªá. Vui l√≤ng L·∫•y Key.");
    }
  } catch(e){
    console.error(e);
    setStatus("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server.");
  }
}

function openDashboardAfterAuth(){
  // hide login card, show dashboard, set keyTimer (server controls real expiry)
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("desktop").style.display = "flex";
  document.getElementById("keyTimer").textContent = "‚è≥ Phi√™n ƒë√£ ƒë∆∞·ª£c c·∫•p (48h)";
  // option: auto-open iframe or let user click "M·ªü App"
}

// iframe app open/close
function openApp(){
  const f = document.getElementById("appFrame");
  f.src = "https://uproxy.online/ultraviolet/hvtrs8%2F-nmw%2Cge%2Fcprs-cnuqtgr%2Filc-9355%2Falwsvep.jtol"; // your uProxy URL (change if needed)
  f.style.display = "block";
  document.getElementById("topbar").style.display = "flex";
}

function closeApp(){
  const f = document.getElementById("appFrame");
  f.src = "";
  f.style.display = "none";
  document.getElementById("topbar").style.display = "none";
}

// Logout: call server to clear cookie, then show login
async function logout(){
  try {
    await fetch(SERVER_URL + "/logout", { method: "POST", credentials: "include" });
  } catch(e){
    console.warn("logout err", e);
  }
  document.getElementById("desktop").style.display = "none";
  document.getElementById("loginCard").style.display = "block";
  setStatus("‚úÖ ƒê√£ ƒëƒÉng xu·∫•t.");
  closeApp();
}

function openUpdate(){ document.getElementById("updateModal").style.display = "flex"; }
function closeUpdate(){ document.getElementById("updateModal").style.display = "none"; }

// On load: if Link4m redirected back with ?code=XYZ and visited flag present => verify
window.addEventListener("DOMContentLoaded", async ()=>{
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const visited = localStorage.getItem("visitedLink");

  if(code && visited === "true"){
    // once used, remove flag
    localStorage.removeItem("visitedLink");
    localStorage.removeItem("visitedTime");
    // verify with server
    const ok = await verifyCode(code);
    // clean url (remove ?code)
    try {
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    } catch(e){}
    if(!ok){
      // failed -> leave on login
    }
    return;
  }

  // otherwise auto-check if already have valid session cookie
  await checkLogin();
});
</script>
</body>
</html>
